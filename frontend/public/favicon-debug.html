<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Favicon Debug - Gandhi Bai CRM</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .favicon-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 10px 0;
        }
        .favicon-img {
            width: 32px;
            height: 32px;
            border: 1px solid #ddd;
        }
        .status {
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.loading { background: #fff3cd; color: #856404; }
        .code-block {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
        }
        .refresh-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }
        .refresh-btn:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>üéØ Favicon Debug Tool - Where Does Your Tab Icon Come From?</h1>
    
    <div class="debug-section">
        <h2>üìç Current Favicon Status</h2>
        <div id="favicon-status" class="status loading">üîÑ Checking favicon sources...</div>
        
        <div id="favicon-info">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>

    <div class="debug-section">
        <h2>üîç Favicon Sources Analysis</h2>
        <div id="source-analysis">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>

    <div class="debug-section">
        <h2>üåê Database Favicon Test</h2>
        <button class="refresh-btn" onclick="testDatabaseFavicon()">üîÑ Test Database Favicon</button>
        <div id="db-test-result" style="margin-top: 15px;">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>

    <div class="debug-section">
        <h2>üìã All Current Favicon Links</h2>
        <div id="all-favicons">
            <!-- Will be populated by JavaScript -->
        </div>
        <button class="refresh-btn" onclick="refreshFaviconInfo()">üîÑ Refresh Info</button>
    </div>

    <script>
        // API Configuration
        const API_BASE_URL = 'http://localhost:4000/api';
        
        function refreshFaviconInfo() {
            console.log('üîÑ Refreshing favicon information...');
            
            // Get all favicon links currently in the page
            const faviconLinks = document.querySelectorAll('link[rel*="icon"]');
            const allFaviconsDiv = document.getElementById('all-favicons');
            
            if (faviconLinks.length === 0) {
                allFaviconsDiv.innerHTML = '<p style="color: #dc3545;">‚ùå No favicon links found in document head!</p>';
            } else {
                let html = '<h4>Found ' + faviconLinks.length + ' favicon links:</h4>';
                faviconLinks.forEach((link, index) => {
                    html += `
                        <div class="favicon-info">
                            <img src="${link.href}" alt="Favicon ${index + 1}" class="favicon-img" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSIjZGRkIi8+Cjx0ZXh0IHg9IjUiIHk9IjIwIiBmb250LXNpemU9IjEwIiBmaWxsPSIjOTk5Ij5OL0E8L3RleHQ+Cjwvc3ZnPg=='">
                            <div>
                                <strong>Type:</strong> ${link.rel}<br>
                                <strong>URL:</strong> <code>${link.href}</code><br>
                                <strong>Type Attr:</strong> ${link.type || 'Not specified'}
                            </div>
                        </div>
                    `;
                });
                allFaviconsDiv.innerHTML = html;
            }
            
            // Analyze favicon sources
            analyzeSource();
        }
        
        function analyzeSource() {
            const sourceDiv = document.getElementById('source-analysis');
            const faviconLinks = document.querySelectorAll('link[rel*="icon"]');
            
            let analysis = '';
            
            if (faviconLinks.length === 0) {
                analysis = `
                    <div class="status error">‚ùå No favicon found - using browser default</div>
                    <p>The tab icon you see is either:</p>
                    <ul>
                        <li>Browser's default favicon</li>
                        <li>Cached from previous visit</li>
                        <li>Static file at /favicon.ico (if exists)</li>
                    </ul>
                `;
            } else {
                const firstFavicon = faviconLinks[0];
                const url = firstFavicon.href;
                
                if (url.includes('/uploads/settings/')) {
                    analysis = `
                        <div class="status success">‚úÖ Favicon loaded from DATABASE</div>
                        <p><strong>Source:</strong> Database-stored favicon</p>
                        <p><strong>Path:</strong> <code>${url}</code></p>
                        <p>‚úÖ This is what you wanted - favicon from database!</p>
                    `;
                } else if (url.includes('/favicon.ico')) {
                    analysis = `
                        <div class="status error">‚ö†Ô∏è Favicon loaded from STATIC FILE</div>
                        <p><strong>Source:</strong> Static favicon file</p>
                        <p><strong>Path:</strong> <code>${url}</code></p>
                        <p>This means database favicon loading failed or is not working.</p>
                    `;
                } else {
                    analysis = `
                        <div class="status loading">ü§î Unknown favicon source</div>
                        <p><strong>URL:</strong> <code>${url}</code></p>
                        <p>Need to investigate this favicon source.</p>
                    `;
                }
            }
            
            sourceDiv.innerHTML = analysis;
        }
        
        async function testDatabaseFavicon() {
            const resultDiv = document.getElementById('db-test-result');
            resultDiv.innerHTML = '<div class="status loading">üîÑ Testing database favicon...</div>';
            
            try {
                console.log('üéØ Testing database favicon endpoint...');
                
                // Test the favicon API endpoint
                const response = await fetch(`${API_BASE_URL}/settings/favicon`);
                
                if (!response.ok) {
                    throw new Error(`API responded with status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üìä Database favicon response:', data);
                
                if (data.success && data.faviconUrl) {
                    const fullUrl = data.faviconUrl.startsWith('/') 
                        ? `${API_BASE_URL.replace('/api', '')}${data.faviconUrl}`
                        : data.faviconUrl;
                    
                    resultDiv.innerHTML = `
                        <div class="status success">‚úÖ Database favicon API working!</div>
                        <div class="favicon-info">
                            <img src="${fullUrl}" alt="Database Favicon" class="favicon-img" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSIjZGRkIi8+Cjx0ZXh0IHg9IjUiIHk9IjIwIiBmb250LXNpemU9IjEwIiBmaWxsPSIjOTk5Ij5OL0E8L3RleHQ+Cjwvc3ZnPg=='">
                            <div>
                                <strong>Database URL:</strong> <code>${data.faviconUrl}</code><br>
                                <strong>Full URL:</strong> <code>${fullUrl}</code><br>
                                <strong>Timestamp:</strong> ${data.timestamp}
                            </div>
                        </div>
                        <button class="refresh-btn" onclick="applyDatabaseFavicon('${fullUrl}')">üîÑ Apply This Favicon Now</button>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="status error">‚ùå Database returned invalid data</div>
                        <div class="code-block">${JSON.stringify(data, null, 2)}</div>
                    `;
                }
                
            } catch (error) {
                console.error('‚ùå Database favicon test failed:', error);
                resultDiv.innerHTML = `
                    <div class="status error">‚ùå Database favicon test failed</div>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p>Possible causes:</p>
                    <ul>
                        <li>Backend server not running on port 4000</li>
                        <li>Database connection issues</li>
                        <li>No favicon stored in database</li>
                        <li>API endpoint not configured</li>
                    </ul>
                `;
            }
        }
        
        function applyDatabaseFavicon(url) {
            console.log('üîß Applying database favicon:', url);
            
            // Remove existing favicons
            const existing = document.querySelectorAll('link[rel*="icon"]');
            existing.forEach(link => link.remove());
            
            // Add new favicon with cache busting
            const timestamp = Date.now();
            const faviconUrl = `${url}?v=${timestamp}`;
            
            const favicon = document.createElement('link');
            favicon.rel = 'icon';
            favicon.type = 'image/x-icon';
            favicon.href = faviconUrl;
            document.head.appendChild(favicon);
            
            const shortcutIcon = document.createElement('link');
            shortcutIcon.rel = 'shortcut icon';
            shortcutIcon.type = 'image/x-icon';
            shortcutIcon.href = faviconUrl;
            document.head.appendChild(shortcutIcon);
            
            console.log('‚úÖ Database favicon applied successfully!');
            
            // Refresh the info
            setTimeout(refreshFaviconInfo, 500);
            
            // Update status
            document.getElementById('favicon-status').innerHTML = '‚úÖ Database favicon applied successfully!';
            document.getElementById('favicon-status').className = 'status success';
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Favicon debug tool loaded');
            refreshFaviconInfo();
            
            // Update status based on current favicon
            const statusDiv = document.getElementById('favicon-status');
            const faviconLinks = document.querySelectorAll('link[rel*="icon"]');
            
            if (faviconLinks.length === 0) {
                statusDiv.textContent = '‚ö†Ô∏è No favicon configured - using browser default';
                statusDiv.className = 'status error';
            } else {
                const url = faviconLinks[0].href;
                if (url.includes('/uploads/settings/')) {
                    statusDiv.textContent = '‚úÖ Favicon loaded from database';
                    statusDiv.className = 'status success';
                } else {
                    statusDiv.textContent = '‚ö†Ô∏è Using static favicon (not from database)';
                    statusDiv.className = 'status error';
                }
            }
        });
    </script>
</body>
</html>
